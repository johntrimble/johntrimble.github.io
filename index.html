
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>John Trimble</title>
  <meta name="author" content="John Trimble">

  
  <meta name="description" content="About a year ago, I was listening to a talk by Chris Granger on how he leveraged the Entity Component System (ECS) architectural pattern when &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://johntrimble.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="John Trimble" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-48260723-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">John Trimble</a></h1>
  
    <h2>Tinkerer, Problem Solver, Software Engineer</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:johntrimble.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/papers">Papers</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/01/14/entity-component-system/">Entity Component System</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-01-14T11:55:23-07:00" pubdate data-updated="true">Jan 14<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>About a year ago, I was listening to a <a href="http://www.youtube.com/watch?v=V1Eu9vZaDYw">talk</a> by Chris Granger on how he leveraged the Entity Component System (ECS) architectural pattern when building LightTable. I&rsquo;d never heard of the pattern before, probably because it typically finds its use in video games, and I don&rsquo;t really do anything in the way of video game development. Chris did a pretty good job selling the approach, so I decided to try it for myself. A couple of months ago, I started working on an Asteroids-like <a href="https://github.com/johntrimble/asteroids">game</a> as a side project to evaluate this pattern, my particular interest being its effectiveness at facilitating code reuse, decoupling, and testing. It&rsquo;s not done, but I&rsquo;m sufficiently far enough along to get a sense of how the pattern plays out in practice. I won&rsquo;t go over what the ECS is (check out Chris&rsquo;s talk or the Wikipedia <a href="http://en.wikipedia.org/wiki/Entity_component_system">article</a> if you&rsquo;re interested in that), but instead just give a brief evaluation of its effectiveness.</p>

<h2>Code Reuse</h2>

<p>This does turn out to be a real win. By simply adding a new property to an entity, I can endow it with new behavior. For example, by giving the camera entity a <code>movement</code> component, I can make it so that it rotates or scrolls. I can also make the ship explode in the same manner as the asteroids by giving it an <code>asteroid-explosive-death</code> component. This means that once I add a new set of components and systems, I can take advantage of them on any entity that I&rsquo;d like. Definitely a big win for code reuse!</p>

<h2>Decoupling</h2>

<p>The story here is a bit more mixed. On the one hand, the different systems do not directly call each other, and this leads some people to conclude that they aren&rsquo;t coupled, but lets take a look at that. Here&rsquo;s the function that takes a world at time t<sub>1</sub> and generates a world at time t<sub>2</sub>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">next-world</span> <span class="p">[</span><span class="nv">world</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">-&gt; </span><span class="nv">world</span>
</span><span class='line'>      <span class="nv">keyboard/keyboard-system</span>
</span><span class='line'>      <span class="nv">intents/intent-system</span>
</span><span class='line'>      <span class="nv">intents/rotation-system</span>
</span><span class='line'>      <span class="nv">intents/thrust-system</span>
</span><span class='line'>      <span class="nv">projectile/firing-system</span>
</span><span class='line'>      <span class="nv">physics/physics-system</span>
</span><span class='line'>      <span class="nv">physics/collision-detection-system</span>
</span><span class='line'>      <span class="nv">projectile/projectile-collision-resolution-system</span>
</span><span class='line'>      <span class="nv">physics/collision-physics-system</span>
</span><span class='line'>      <span class="nv">health/impulse-damage-system</span>
</span><span class='line'>      <span class="nv">health/damage-resolution-system</span>
</span><span class='line'>      <span class="nv">asteroids/asteroid-death-system</span>
</span><span class='line'>      <span class="nv">health/health-bar-system</span>
</span><span class='line'>      <span class="nv">core/ttl-system</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>In general, it looks pretty simple. Each system takes a world state as a parameter and produces a world state as its value. Then the ability to move a game state forward is realized by composing the various systems together. It&rsquo;s in that composing bit where the complexity hides: the order in which the systems are composed together matters! For example, the <code>impulse-damage-system</code> must be applied after the <code>collision-physics-system</code> as the former is looking for entities with an <code>impulse</code> component which is added by the <code>collision-physics-system</code>. One cannot simply look at the systems in isolation, but must have an awareness of how the systems interact with each other, which increases the cognitive load when adding, modifying, or removing systems. On the plus side, the systems are at least loosely coupled as they just care about the world being in some state, not about who put it in that state.</p>

<p>Of course, one could argue that this complexity is inherent in the problem (i.e. there&rsquo;s just no avoiding it), or not a failing of entity component system, but rather an issue with the way I applied that pattern. The important thing here is to keep in mind that the lack of a direct function call doesn&rsquo;t necessarily mean two parts of a system are decoupled, and it&rsquo;s valuable to identify these areas of complexity because they help you understand where the problems are going to arise.</p>

<h2>Testability</h2>

<p>This turned out to be a huge win. Since none of the systems call each other, each system only cares about the world state passed into it, and none of them (at least none of the ones listed above) have any side effects, testing is a breeze! Here&rsquo;s what one of my unit tests for the <code>physics-system</code> looks like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">a</span> <span class="p">(</span><span class="nf">core/entity</span> <span class="p">(</span><span class="nf">core/movement</span> <span class="p">[</span><span class="mi">1</span> <span class="mf">0.5</span><span class="p">]</span>
</span><span class='line'>                                    <span class="p">[</span><span class="mi">2</span> <span class="mi">1</span><span class="p">]</span>
</span><span class='line'>                                    <span class="nv">math/infinity</span>
</span><span class='line'>                                    <span class="mi">0</span>
</span><span class='line'>                                    <span class="mi">0</span>
</span><span class='line'>                                    <span class="nv">math/infinity</span><span class="p">)</span>
</span><span class='line'>                     <span class="p">(</span><span class="nf">core/position</span> <span class="p">[</span><span class="mi">5</span> <span class="mi">5</span><span class="p">])</span>
</span><span class='line'>                     <span class="p">(</span><span class="nf">core/aabb</span> <span class="p">[</span><span class="mi">4</span> <span class="mi">4</span><span class="p">]</span> <span class="p">[</span><span class="mi">6</span> <span class="mi">6</span><span class="p">]))</span>
</span><span class='line'>      <span class="nv">world</span> <span class="p">(</span><span class="nf">core/assoc-entity</span> <span class="p">{}</span> <span class="nv">a</span><span class="p">)</span>
</span><span class='line'>      <span class="nv">a</span> <span class="p">(</span><span class="nf">core/get-entity</span> <span class="nv">world</span> <span class="p">(</span><span class="nf">core/get-id</span> <span class="nv">a</span><span class="p">))</span>
</span><span class='line'>      <span class="nv">world-new</span> <span class="p">(</span><span class="nf">physics/physics-system</span> <span class="nv">world</span><span class="p">)</span>
</span><span class='line'>      <span class="nv">a-new</span> <span class="p">(</span><span class="nf">core/get-entity</span> <span class="nv">world-new</span> <span class="p">(</span><span class="nf">core/get-id</span> <span class="nv">a</span><span class="p">))]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">describe</span> <span class="s">&quot;physics-system&quot;</span>
</span><span class='line'>            <span class="p">(</span><span class="nf">it</span> <span class="s">&quot;should update velocity by acceleration&quot;</span>
</span><span class='line'>                <span class="p">(</span><span class="nf">should=</span> <span class="p">[</span><span class="mi">3</span> <span class="mf">1.5</span><span class="p">]</span> <span class="p">(</span><span class="nf">core/get-velocity</span> <span class="nv">a-new</span><span class="p">)))</span>
</span><span class='line'>            <span class="p">(</span><span class="nf">it</span> <span class="s">&quot;should update velocity before updating position&quot;</span>
</span><span class='line'>                <span class="p">(</span><span class="nf">should-not=</span> <span class="p">[</span><span class="mi">7</span> <span class="mi">6</span><span class="p">]</span> <span class="p">(</span><span class="nf">core/get-position</span> <span class="nv">a-new</span><span class="p">)))</span>
</span><span class='line'>            <span class="p">(</span><span class="nf">it</span> <span class="s">&quot;should update the position&quot;</span>
</span><span class='line'>                <span class="p">(</span><span class="nf">should=</span> <span class="p">[</span><span class="mi">8</span> <span class="mf">6.5</span><span class="p">]</span> <span class="p">(</span><span class="nf">core/get-position</span> <span class="nv">a-new</span><span class="p">)))</span>
</span><span class='line'>            <span class="p">(</span><span class="nf">it</span> <span class="s">&quot;should provide a valid value for rotation&quot;</span>
</span><span class='line'>                <span class="p">(</span><span class="nf">should-not</span> <span class="p">(</span><span class="nf">js/isNaN</span> <span class="p">(</span><span class="nf">core/get-rotation</span> <span class="nv">a-new</span><span class="p">))))</span>
</span><span class='line'>            <span class="p">(</span><span class="nf">it</span> <span class="s">&quot;should provide a valid value for angular components&quot;</span>
</span><span class='line'>                <span class="p">(</span><span class="nf">should-not</span> <span class="p">(</span><span class="nf">js/isNaN</span> <span class="p">(</span><span class="nf">core/get-angular-velocity</span> <span class="nv">a-new</span><span class="p">)))</span>
</span><span class='line'>                <span class="p">(</span><span class="nf">should-not</span> <span class="p">(</span><span class="nf">js/isNaN</span> <span class="p">(</span><span class="nf">core/get-angular-acceleration</span> <span class="nv">a-new</span><span class="p">))))</span>
</span><span class='line'>            <span class="p">(</span><span class="nf">it</span> <span class="s">&quot;should update the aabb&quot;</span>
</span><span class='line'>                <span class="p">(</span><span class="nf">should=</span> <span class="p">[[</span><span class="mi">7</span> <span class="mf">5.5</span><span class="p">]</span> <span class="p">[</span><span class="mi">9</span> <span class="mf">7.5</span><span class="p">]]</span> <span class="p">(</span><span class="nf">core/get-aabb</span> <span class="nv">a</span><span class="p">)))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice how there aren&rsquo;t any mocks. I just build a world state, call the system, and verify that the new world state looks the way it should. I wish that everything I did was this straight forward to test!</p>

<h2>Conclusion</h2>

<p>In general, I found that entity component system, as an architectural pattern, really shined in regards to code reuse and testability. I did not find the different systems as insulated from each other as I originally expected, but nonetheless, the complexity is manageable, especially with how easy testing is. My next step&mdash;other than actually finishing the game&mdash;is to investigate its viability in contexts outside of game development. LightTable just recently became open source, and since Chris Granger&rsquo;s talk on how he used this pattern in LightTable got me interested in the first place, I&rsquo;ll probably start there by analyzing its source code.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/07/11/building-an-incremental-rotary-encoder/">Building a Quadrature Rotary Encoder</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-11T22:42:00-07:00" pubdate data-updated="true">Jul 11<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Today I document the saga of building an quadrature rotary encoder. I undertook the project as a way to become more familiar with electronics. My more optimistic past self thought the task relatively straight forward, but a few months of misteps, redsigns, and code rewrites have taught me otherwise. Nonetheless, it&rsquo;s been quite a learning experience, and hopefully this post will provide some guidance to anyone taking on a similar project.</p>

<h2>Basics of a Quadrature Rotary Encoder</h2>

<p>A quadrature encoder translates rotational changes of an object into a digital signal. They have a number applications, including robotics where they are used to determine velocity and position which can be infered from the rotation of the motor shaft(s). There are a number of ways to do this, but the ways I&rsquo;ve experimented with involve an encoder wheel (Figure 1), and the use of infared emitters and collectors. To keep it simple for now, lets consider only one emitter and one collector. The encoder wheel is designed to alternate the amount of infared light reaching the collector from low to high at regular intervals as it rotates. One can acheive this by either &ldquo;cutting out&rdquo; the black sections in Figure 1 and placing the collector on one side of the disc and the emitter on the other such that as the disc rotates it will block and unblock the collector. The other method involves taking advantage of how light colors reflect more infared light than dark colors. Thus by placing the emitter and collector on the colored side of the encoder wheel, the same effect can be achieved as the amount of infared reflected will vary from low to high, and consequently the amount reaching the collector will vary from low to high, as the encoder wheel turns. In both cases, the analog output of the collector will look something like Figure 2 which is then turned into a digital signal also show in Figure 2.</p>

<figure class="center" style="width: 100%;">
  <img src="/images/posts/building-an-incremental-rotary-encoder/encoder-wheel.svg" style="width: 100%;"></img>
  <figcaption>Figure 1. Single channel encoder wheel (left) and a two channel encoder wheel (right).</figcaption>
</figure>




<figure class="center" style="width: 100%;">
  <img src="/images/posts/building-an-incremental-rotary-encoder/analog-digital-wave.svg" style="width: 100%;"></img>
  <figcaption>Figure 2. An analog wave (top) and a digital square wave (below).</figcaption>
</figure>


<p>From this signal, one can determine speed based upon the frequency&mdash;the higher the frequency, the higher the speed. Unfortunately, this signal doesn&rsquo;t provide one critical piece of information: the direction.</p>

<figure class="center" style="width: 100%;">
  <img src="/images/posts/building-an-incremental-rotary-encoder/quadrature-signal.svg" style="width: 100%;"></img>
  <figcaption>Figure 3. Quardrature signal and the corresponding gray codes representing each possible state.</figcaption>
</figure>


<p>By adding a second emitter/collector pair, radially aligned with the first pair, and adding a second encoder track to the encoder wheel offset by one quarter cycle as in Figure 1, the signal generated by both collectors will provide the direction. Call the outer track channel A and the inner track channel B, the collectors will produce a signal like in Figure 3, known as a quadrature signal, when the encoder wheel is rotating. For any point in time, these two square waves fall into 4 possible states, which can be represented by two digit binary codes called gray codes:</p>

<ul>
<li>channel A high and channel B high (11)</li>
<li>channel A high and channel B low (10)</li>
<li>channel A low and channel B high (01)</li>
<li>channel A low and channel B low (00)</li>
</ul>


<p>When the wheel turns clockwise, it produces the sequence of gray codes: 00, 01, 11, 10, 00, 01, etc. When turned counterclockwise, it produces the same sequence but in the opposite order: 00, 10, 11, 01, 00, 10, etc. Thus the direction of rotation can be inferred from the order of the gray codes. That&rsquo;s the basics of an quadrature rotary encoder.</p>

<h2>What I&rsquo;m looking for</h2>

<p>I have a somewhat larger robotics project I&rsquo;ve been considering working on (I won&rsquo;t talk about the specifics until I start on it), and this encoder fits into that larger scope. In this larger project, I&rsquo;m considering using a scooter motor and wheels for locomotion, and I want to build a pair of encoders to get rotational information from the scooter wheels which I can then use to determine velocity and position. The encoders will also tie into a <a href="http://www.dimensionengineering.com/products/kangaroo">Kangaroo motion controller</a>, which will in turn drive a <a href="http://www.dimensionengineering.com/products/sabertooth2x12">Sabertooth motor controller</a>. For the most part, the standard quadrature output covers my basic needs; however, I have a few other features in mind such as being able to calibrate the encoders programmatically, perform error checking and error notification, and also provide some basic encoder state information via an <a href="http://en.wikipedia.org/wiki/I%C2%B2C">I<sup>2</sup>C interface</a>.</p>

<h2>Trial and Error</h2>

<h3>Attempt 1 &ndash; Photo Interrupter</h3>

<p>For my first attempt, I thought I&rsquo;d keep things simple, and then build upon it later once I got something working. I decided to use a disruption technique by which the encoder wheel would disrupt infared transmission from an emitter to a collector as it turned, as opposed to some sort of infared reflection approach. In the spirit of keeping things simple, I built a single channel encoder wheel out of a paper plate by cutting 180 prongs/teeth out of it. I attached it to the sproket of the scooter wheel I was building the encoder for using rare earth magnets (of course, I intended to come up with a more robust solution later). With 180 teeth in the encoder wheel, I could achieve (or thought at least) a resolution of 180 pulses per revolution, which seemed conservative as encoders with over 5 times the resolution are both relatively common and cheap (e.g. <a href="https://www.sparkfun.com/products/11102">this</a> encoder on SparkFun). For the infared emitter/collector, I purchased a <a href="https://www.sparkfun.com/products/9299">GP1A57HRJ00F photo interrupter</a> from <a href="https://www.sparkfun.com">SparkFun</a>. What made this photo interrupter ideal was that it already had the infared emitter and collector aligned with a perfect slot for the encoder wheel to pass through. It also produced a simple digital output, no analog jazz to worry about. I utilized an Arduino Uno to process the quadrature signal by polling a digital pin connected to the output of the IR collector. It simply wrote to the serial device whenever a revolution was completed.</p>

<p>The first issue I ran into was cutting out the teeth in the encoder wheel. I didn&rsquo;t really have a great solution for this, and ended up spending a couple mind numbing hours cutting out the individual teeth one at a time. I should have just printed the encoder wheel on a transparency, which would have obviated the need to cut any teeth out at all.</p>

<p>Aside from the time consuming annoyance of the encoder wheel, there was also the little issue of the encoder flat out not working at all. The number of pulses recorded per revolution undercut the expected 180 by as much as 20 pulses. To make matters worse, the results were not consistent. I concluded that some of the teeth on the encoder wheel were too thin to properly block the IR. I tried reworking the wheel a few times but the results didn&rsquo;t get much better. In retrospect, what I originally saw as a benifit of the GP1A57HRJ00F photo interrupter was probably a draw back as it&rsquo;s digital output denied me the abiliy to adjust the collectors threshold as to what denotes an ON state versus an OFF state. I could have also addressed this issue by reducing resolution (putting fewer teeth in the encoder wheel) but I was still too naive to sacrifce resolution for the sake of getting something that at least functioned.</p>

<h3>Attempt 2 &ndash; IR Reflection</h3>

<p>After spending the better part of a month trying to get the disruption approach to work, I decided to switch gears and use IR reflection instead. I purchased a <a href="https://www.sparkfun.com/products/241">SEN-00241</a> IR emitter and collector pair to use for the sensor. I went with a single channel once again just to try and get something working. Instead of creating an encoder wheel to mount on a scooter wheel, I simply printed one out, punched a hole through it, and attached it to a pencil. I then built a relatively stable mount for it out of an old Saltine Crackers box. At this point, I just wanted to see some positive results before I went to the trouble of making something more permanent.</p>

<p>I used the Arduino Uno in much the same way as I did previously, except now it was reading an analog input coming from the IR collector. I set up a calibration routine where I&rsquo;d rotate the wheel and then it would compute the average value from the analog input and use that as the threshold between the ON and OFF states. It would then continuoulsy poll the analog input to detect state transitions.</p>

<p>The main issue with relying on IR reflection is that it varies not only with the color of the surface but also the distance of that surface from the emitter/collector&mdash;the further the surface is away, the less IR light makes it back to the collector. Indeed, IR sensors like this are frequently used as proximity sensors. Consequently, in order to detect light and dark surfaces properly, the distance from the surface must be held constant. Unfortunately, the cut up paper plates I&rsquo;d been using tend to warp, meaning the encoder wheel&rsquo;s distance from the IR emitter/collector varies as it turns. Of course, I could have switched to a more robust material, but then I got an idea that would make such uneccessary.</p>

<h3>Attempt 3 &ndash; Encoder Strip and Sprocket Flange</h3>

<p>After spending more time than I care to remember fighting with encoder wheels, I realized that I didn&rsquo;t really need one. The scooter wheel I&rsquo;m using connects to a sprocket using a flange  and that flange happens to be just wide enough for an encoder strip (Figure 4). I wrote a small Groovy script to generate the encoder strip, printed it on standard printer paper, cut it out, and then glued it with some Elmer&rsquo;s stick glue to the flange. Again, I started with a single channel, and I used the same SEN-00241 IR emitter/collector pair as before. The initial results were promising. I could acurately determine when the wheel had completed a revolution (so long as I didn&rsquo;t change the direction of rotation).</p>

<figure class="center" style="width: 100%;">
  <img src="/images/posts/building-an-incremental-rotary-encoder/encoder-strip-sprocket-flange.jpg" style="width: 100%;"></img>
  <figcaption>Figure 4. Encoder strip around the sprocket flange of the scooter wheel.</figcaption>
</figure>


<p>With this initial success, I added a second channel to the encoder strip and purchased a pair of <a href="https://www.sparkfun.com/products/9453">QRE1113 Line Sensor Breakouts</a> from SparkFun. The main advantage of these sensor breakouts is that I can use a single 6-pin header to hold both sensors keeping them perfectly aligned with each other. I updated my code to calibrate both sensors and then to poll continuously both analog inputs. I also made it print out the current gray code as the wheel rotate. Briefly experimenting with it, everything seemed fine, but then I decided to do something crazy and add  error checking.</p>

<p>Not all sequences of gray codes are valid. For example, you can&rsquo;t go from 10 to 01 or 11 to 00. When an invalid transition happens, it usually means something not good just occurred. It could be that the encoder wheel is turning too fast for the encoder to keep up, the encoder strip/wheel might be damaged, the IR sensors could be out of alignment, or something of that sort. The error checking I added detected these erroneous transitions which it found with great frequency, especially when the wheel rotated at higher speeds. Even after reducing the resolution from 184 pulses per revolution to 92, the issue persisted.</p>

<p>My first guess as to the source of the problem was that, as I spun the wheel faster, the vibrations caused the distance to fluctuate between the IR sensors and the encoder strip, so I built a more stable mount for the IR sensors (alright, I used foamboard and a hot glue gun, but that should have been stable enough given my setup). This had no impact on the encoders performance.</p>

<p>I then decided it must be noise issues with the analog signal (at the time, I didn&rsquo;t have an oscilliscope), so I updated my code to use a moving average filter. Again, nothing, in fact, the moving average filter seemed to do more harm than good. I also tried a median filter that also didn&rsquo;t help, but didn&rsquo;t seem to make things worse either.</p>

<p>Okay, not noise, not vibrations, what else? Well, the Arduino likes to take its time when performing analog reads. I calculated that at the faster speeds I spun the scooter wheel at, it could only manage 10 or so analog reads per encoder state. Given that the IR sensors were likely slightly misaligned, and the calibration of the sensors probably fell a bit short of optimal, the frequency at which the analog inputs were sampled may simply not have been high enough to catch every state transition. However, I would have expected decreasing the resolution to help more than it did. Another potential issue is that the Arduino needs to charge an internal capicitor when performing an analog read, which can be problematic if there isn&rsquo;t sufficent current on the inputs to charge the capacitor in a reasonable amount of time, though I didn&rsquo;t really look into this much.</p>

<p>There are a number of ways I could have dealt with the poor analog read performance. I could have bypassed Arduino&rsquo;s <code>analogRead(..)</code> function and its overhead. I could have sacrificed analog read percision to increase the sampling rate. I could have fixed any alignment issues with the IR sensors. I could have done all those things, but I decided there was a better way to go about getting state information from the sensors.</p>

<h3>Attempt 4 &ndash; Encoder Strip with Interrupts</h3>

<p>Since detecting state transitions by polling didn&rsquo;t work, I decided to go the interrupt route instead. I avoided using interrupts up to this point mainly due to their rather negative impact on code complexity. Dealing with the flow of execution getting yanked away at any point, and ensuring the interrupt handlers and main loop don&rsquo;t read or write global data in an inconsistent manner, is hard to manage in an elegant and simple way.</p>

<p> I purchased some <a href="http://www.digikey.com/product-detail/en/MCP42010-I%2FP/MCP42010-I%2FP-ND/362084">Microchip MCP42010 digital potentiometers</a> and <a href="http://www.digikey.com/product-detail/en/LM339N/296-1393-5-ND/277628">TI LM339N voltage comparators</a> from <a href="http://www.digikey.com/">DigiKey</a>. The analog signals from the IR sensors were fed through the voltage comparators and their output went to an interrupt on the Arduino. The digital potentiometers were used to create the reference voltage for the voltage comparators and were appropriately programmed during calibration. There were also some extensive code changes as well which I won&rsquo;t go into here.</p>

<p>This approach generated immediate positive results. I currently have the encoder operating with a resolution of 180 pulses per revolution with no issues. There are still a number software problems to work out, and hardware wise, I still need to make a ciruit board, but the main obsticales to progress have finally been overcome.</p>

<h2>Next Steps</h2>

<p>Now that I have a working circuit, I need to start looking into how to turn that circuit into a circuit board. Luckily, my friend <a href="http://stuffandymakes.com/">Andy</a> recently showed me how to go about making a circuit board using a DIY photoresist method which, at least when he does it, produces some rather impressive results with a relatively low time/money investment.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/04/24/migrating-from-wordpress-com-to-wordpress-org/">Migrating From WordPress.com to WordPress.org</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-04-24T07:08:00-07:00" pubdate data-updated="true">Apr 24<span>th</span>, 2011</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Recently at <a href="http://www.meltmedia.com/">meltmedia</a>, I had to port a blog for one of our clients from WordPress.com to a self-hosted WordPress.org install. Normally, most of the work I do is with Java, JBoss, OSGi and technologies of that sort, so working with WordPress and PHP was quite a new experience for me. At first, the thought of porting a WordPress.com blog to a self-hosted WordPress.org solution seemed like a simple matter, but it ended up being more involved than I expected.</p>

<p>Our client used a number WordPress.com features not available in a vanilla WordPress.org install, namely: social network sharing for posts, publicizing tools for Twitter and Facebook (among others), slideshows, email subscriptions, site stats, short links, embedded video shortcodes, a Twitter feed widget, and special support for mobile clients. WordPress.com provides some of these features through equivalent plugins for WordPress.org, others are just 3rd party plugins, and some are proprietary with no directly equivalent WordPress.org counterpart.</p>

<p>I originally installed the Sharedaddy, WordPress.com Stats, and Wickett Twitter Widget plugins to provide the social networking for posts, stats, and twitter widget functionality respectively, but later on switched to using WordPress.com’s Jetpack plugin (released while I was working on the port) which provides the same features as well as shortcodes for embedded videos and short links. Jetpack proves satisfactory in most respects, though it does have the drawback of requiring a WordPress.com account (not a big deal since the client already had one) and the plugin also requires that any WordPress.org instance using it be on a publicly accessible domain, which is problematic for development where I prefer to work (as I assume most developers do) on my localhost. Unfortunately, while JetPack does fill a number of gaps, there are still some proprietary features of WordPress.com for which it does not provide support, slideshows in particular.</p>

<p>WordPress.com has this nice feature where if you put a <code>[slideshow]</code> shortcode in a post’s content, it will be replaced by an animated slideshow of the images attached to the post. To my knowledge, WordPress.com provides no plugin for this feature, though they stated in a blog <a href="http://en.blog.wordpress.com/2010/03/31/share-photos-with-a-slideshow/">post</a> from over a year ago that such a plugin would soon be available. Sadly, despite my best efforts, I could not find a suitable plugin to provide the same functionality. While there is certainly no shortage of slideshow plugins for WordPress.org, each of them seems to have one shortcoming or another. For example, <a href="http://wordpress.org/extend/plugins/nextgen-gallery/">NextGEN Gallery</a> provides, among many other great features, support for in post slideshows, but it was incompatible with the WPtouch plugin that I also needed, and it doesn’t simply use the images attached to the post, but requires a set of images to be uploaded and grouped together separately from the post. Arguably, this latter issue is less of a shortcoming than a more appropriate and flexible way to manage the relavent data, but I wanted to make the change of hosts as transparent as possible to the client, and requiring them to manage such information elsewhere seemed too disruptive to their existing work flow. I also looked into <a href="http://wordpress.org/extend/plugins/slideshow-gallery-2/">Slideshow Gallery</a>, and a number of its derivatives, but they had poor support for images of varying sizes and also proved similarly difficult to get working with the WPtouch plugin. In the end, I was unable to find a replacement for the slideshow feature, though I’m hoping a future version of Jetpack will include such support. I’ve been toying with the idea of creating my own replacement, the WordPress.com slideshow is essentially just a wrapper for the jQuery cycle plugin, but time being the rare commodity it is, I’ve yet to get around to it.</p>

<p>Email subscriptions is another area where no directly equivalent plugin exists. I ended up electing to use <a href="http://wordpress.org/extend/plugins/slideshow-gallery-2/">MailPress</a> to fulfill this requirement, which is overkill for the task, user subscription for notification by email of new posts and comments on the site, but it works. Transferring existing subscriptions over proved relatively simple. A subscriber list CSV export can be acquired through the WordPress.com admin interface (it’s located, somewhat confusingly, in the stats section), and MailPress has a subscriber import tool which can import the data. The only issue was that MailPress didn’t like that the CSV file generated by WordPress.com had only a single column, but its complaints were silenced by simply adding a comma to the end of each line in the CSV.</p>

<p>The mobile optimized support that WordPress.com offers comes from the <a href="http://www.bravenewcode.com/store/plugins/wptouch-pro/">WPtouch Pro</a> plugin that I eluded to earlier. Out of the box, it’s pretty much configured in the same way it is on WordPress.com, so it took little effort to get it working. I do have some issues with the plugin itself, but none relavent to someone who simply wants to port a blog from WordPress.com to a WordPress.org install.</p>

<p>Porting the data itself from WordPress.com to the new WordPress.org instance was for the most part painless. WordPress comes with a built in export tool that allows for the export of all post data (including custom post types) from a WordPress install, and this export can be easily imported into a WordPress.org install using the WordPress Importer plugin. However, there isn’t any  mechanism to transfer theme, site, and plugin configuration from WordPress.com, so this ends up being a manual process filled with tedium and potential for error. I wrote a script to configure most of this for me during development, but there isn’t a good way, that I’m aware of, to automate the entire ordeal. To redirect users from the WordPress.com blog to the new WordPress.org instance, the client purchase WordPress.com’s <a href="http://en.support.wordpress.com/site-redirect/">site redirect</a> upgrade. Unfortunately, it’s not free costing $12.00 per year, but it does work.</p>

<p>In the end, the blog migration from WordPress.com to a self-hosted WordPress.org site was a success, albeit not quite the smooth transition I’d hoped for. The only feature missed from WordPress.com was it’s slideshow support, but I imagine with some additional effort that issue could be addressed. For those looking into porting a WordPress.com blog themselves, here are the plugins I ended up using: <a href="http://wordpress.org/extend/plugins/jetpack/">Jetpack</a>, <a href="http://wordpress.org/extend/plugins/mailpress/">MailPress</a>, <a href="http://wordpress.org/extend/plugins/akismet/">Akismet</a>, <a href="http://www.bravenewcode.com/store/plugins/wptouch-pro/">WPtouch Pro</a>, and <a href="http://wordpress.org/extend/plugins/simple-twitter-connect/">Simple Twitter Connect</a> with the STC – Publish add-on.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/01/14/entity-component-system/">Entity Component System</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/11/building-an-incremental-rotary-encoder/">Building a Quadrature Rotary Encoder</a>
      </li>
    
      <li class="post">
        <a href="/blog/2011/04/24/migrating-from-wordpress-com-to-wordpress-org/">Migrating From WordPress.com to WordPress.org</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Tweets</h1>
<a class="twitter-timeline" height="300" width="100%" data-tweet-limit="2" data-dnt="true" href="https://twitter.com/johntrimble" data-widget-id="353888304896307200" data-chrome="noheader noscrollbar transparent">Tweets by @johntrimble</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/johntrimble">@johntrimble</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'johntrimble',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - John Trimble -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'johntrimble';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
